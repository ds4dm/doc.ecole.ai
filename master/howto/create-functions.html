

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Create New Functions &mdash; Ecole 0.1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Create New Environments" href="create-environments.html" />
    <link rel="prev" title="Use Reward Functions" href="reward-functions.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/ecole-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using-environments.html">Using Environments</a></li>
</ul>
<p class="caption"><span class="caption-text">How to</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="observation-functions.html">Use Observation Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="reward-functions.html">Use Reward Functions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Create New Functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#from-an-exsiting-one">From an Exsiting One</a></li>
<li class="toctree-l2"><a class="reference internal" href="#from-scratch">From Scratch</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="create-environments.html">Create New Environments</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ds4dm/ecole/tree/master/examples/configuring-bandits.ipynb">Configuring the Solver with Bandits</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/ds4dm/ecole/tree/master/examples/branching-imitation.ipynb">Branching with Imitation Learning</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/observations.html">Observations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/rewards.html">Rewards</a></li>
</ul>
<p class="caption"><span class="caption-text">Discussion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../discussion/gym-differences.html">Differences with OpenAi Gym</a></li>
<li class="toctree-l1"><a class="reference internal" href="../discussion/seeding.html">Seeding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../discussion/theory.html">Ecole Theoretical Model</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ecole</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Create New Functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/ds4dm/ecole/blob/master/docs/howto/create-functions.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="create-new-functions">
<h1>Create New Functions<a class="headerlink" href="#create-new-functions" title="Permalink to this headline">¶</a></h1>
<p>:<a class="reference internal" href="observation-functions.html#use-observation-functions"><span class="std std-ref">Observation</span></a> and :<a class="reference internal" href="reward-functions.html#use-reward-functions"><span class="std std-ref">reward</span></a> functions
can be adapted and created from Python.</p>
<p>At the core of the environment, a SCIP <code class="docutils literal notranslate"><span class="pre">Model</span></code> (equivalent to a <code class="docutils literal notranslate"><span class="pre">pyscipopt.Model</span></code> or a
<code class="docutils literal notranslate"><span class="pre">SCIP*</span></code> in <code class="docutils literal notranslate"><span class="pre">C</span></code>), describe the state of the environment.
The idea of observation and reward functions is to have a function that takes as input that
<code class="docutils literal notranslate"><span class="pre">Model</span></code>, and return the desired value (an observation, or a reward).
The environment itself does nothing more than calling the function and forward its output to the
user.</p>
<p>Pratically speaking, it is more convenient to implement such functions as a class that a function,
as it makes it easier to keep information between states.</p>
<div class="section" id="from-an-exsiting-one">
<h2>From an Exsiting One<a class="headerlink" href="#from-an-exsiting-one" title="Permalink to this headline">¶</a></h2>
<p>To reuse a function, Python inheritance can be use.
In the following, we will adapt <a class="reference internal" href="../reference/observations.html#ecole.observation.NodeBipartite" title="ecole.observation.NodeBipartite"><code class="xref py py-class docutils literal notranslate"><span class="pre">NodeBipartite</span></code></a> to apply some scaling
to the observation features.</p>
<p>The method that will be called to return an observation is called <code class="docutils literal notranslate"><span class="pre">obtain_observation</span></code>.
Here is how we can create a new observation function that scale the features their maximum absolute
value.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ecole.observation</span> <span class="kn">import</span> <span class="n">NodeBipartite</span>


<span class="k">class</span> <span class="nc">ScaledNodeBipartite</span><span class="p">(</span><span class="n">NodeBipartite</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">obtain_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="c1"># Call parent method to get the original observation</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">obtain_observation</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="c1"># Apply scaling</span>
        <span class="n">column_max_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">column_features</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">column_features</span><span class="p">[:]</span> <span class="o">/=</span> <span class="n">column_max_abs</span>
        <span class="n">row_max_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">row_features</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">row_features</span><span class="p">[:]</span> <span class="o">/=</span> <span class="n">row_max_abs</span>
        <span class="c1"># Return the updated observation</span>
        <span class="k">return</span> <span class="n">obs</span>
</pre></div>
</div>
<p>Here we use the <a class="reference internal" href="../reference/observations.html#ecole.observation.NodeBipartite" title="ecole.observation.NodeBipartite"><code class="xref py py-class docutils literal notranslate"><span class="pre">NodeBipartite</span></code></a> function to do the heavy lifting by
calling the method of the parent class.
Then we scaled some features of that observation and returned the result.
<code class="docutils literal notranslate"><span class="pre">ScaledNodeBipartite</span></code> is a perfectly valid observation function that can be given to an
environment.</p>
<p>To make it smoother, we could apply an
<a class="reference external" href="https://en.wikipedia.org/wiki/Moving_average#Exponential_moving_average">exponential moving average</a>
with coefficient α to the scaling vector.
We will apply the moving average on states from the same episode, and reset it at every new
episode.
This example shows how the scaling vector can be stored between states.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MovingScaledNodeBipartite</span><span class="p">(</span><span class="n">NodeBipartite</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Construct parent class with other parameters</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="c1"># Reset exponential moving average (ema) on new episode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column_ema</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_ema</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">obtain_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">obtain_observation</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># Compute max absolute vector for current observation</span>
        <span class="n">column_max_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">column_features</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">row_max_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">row_features</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># New exponential moving average on new episode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_ema</span> <span class="o">=</span> <span class="n">column_max_abs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_ema</span> <span class="o">=</span> <span class="n">row_max_abs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Update exponential moving average</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column_ema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">column_max_abs</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ema</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">row_ema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">row_max_abs</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_ema</span>

        <span class="c1"># Scale features and return new observation</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">column_features</span><span class="p">[:]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ema</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">row_features</span><span class="p">[:]</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_ema</span>
        <span class="k">return</span> <span class="n">obs</span>
</pre></div>
</div>
<p>Here, you can notice how we used the constructor to be able to customize the coefficient of the
exponential moving average.
We also inherited the <code class="docutils literal notranslate"><span class="pre">reset</span></code> method which does not return anything.
This method is called at the begining of the episode by
<a class="reference internal" href="../using-environments.html#ecole.environment.EnvironmentComposer.reset" title="ecole.environment.EnvironmentComposer.reset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">reset()</span></code></a> and is used to reintialize the class
internal attribute on new episodes.
The <code class="docutils literal notranslate"><span class="pre">obtain_observation</span></code> is also called during during
<a class="reference internal" href="../using-environments.html#ecole.environment.EnvironmentComposer.reset" title="ecole.environment.EnvironmentComposer.reset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">reset()</span></code></a>, hence the <code class="docutils literal notranslate"><span class="pre">if</span></code> else <code class="docutils literal notranslate"><span class="pre">else</span></code> condition.
Both these methods call the parent method to let it do its own initialization/reseting.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The scaling shown in this example is naive implementation meant to showcase the use of
observation function.
For proper scaling functions consider <a class="reference external" href="https://scikit-learn.org/stable/modules/classes.html#module-sklearn.preprocessing">Scikit-Learn Scalers</a></p>
</div>
</div>
<div class="section" id="from-scratch">
<h2>From Scratch<a class="headerlink" href="#from-scratch" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="create-environments.html" class="btn btn-neutral float-right" title="Create New Environments" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="reward-functions.html" class="btn btn-neutral float-left" title="Use Reward Functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Antoine Prouvost

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>